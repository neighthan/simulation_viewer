<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-3d.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script
  src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
  crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>


<div id="container" style="display: flex">
  <div id="chart-container">
    <div id="chart"></div>
    <div id="colorbar"></div>
  </div>
  <div id="tooltip">
    <img id="img1">
    <img id="img2">
    </div>
  </div>
</div>

<style>
  #chart-container {
    height: 100%;
    flex-grow: 1;
    margin: 0 auto;
  }
  #tooltip {
    height: 100%;
    width: 50%;
  }
  #colorbar {
    display: flex;
    flex-direction: row;
    margin: 25px 25px 0px 25px;
  }
  .colorbar-cell {
    flex: 1 1 0px;
  }
  img {
    width: 100%;
  }
</style>

<script>
  // *****
  // everything you need to edit should be in this section
  let xAxisLabel = 'nu'
  // whether to use scientific notation like 2e-6 when using this number in
  // the hover tooltip and looking up image files
  let xScientific = false

  let yAxisLabel = 'dt'
  let yScientific = false

  let zAxisLabel = 'taur'
  let zScientific = true

  let axisLabelSize = 15

  let title = 'Parameter Tuning'
  let subtitle = 'Click and drag to rotate; hover to show images.'

  let chartMargin = 75

  // see http://bl.ocks.org/curran/3094b37e63b918bab0a06787e161607b for examples
  // not all of those are supported, though
  let colorMap = 'Cool'

  // x: nu, y: dt, z: tau_r
  let xyz = [
    [0.01, 0.1, 2e-6],
    [0, 1, 2e-6],
  ]

  let msds = [11, 19] // this will be used to set the color of the points

  // *****

  // coloring things
  let minVal = Math.min.apply(null, msds)
  let maxVal = Math.max.apply(null, msds)
  let colorMapper = d3.scaleSequential(d3[`interpolate${colorMap}`]).domain([minVal, maxVal])

  for (let i in xyz) {
    p = xyz[i]
    xyz[i] = {x: p[0], y: p[1], z: p[2], color: colorMapper(msds[i])}
  }

  // add the color bar
  let nCells = 150
  let colorbar = $('#colorbar')
  for (let i = -1; i <= nCells; i++) {
    let cell = document.createElement('div')
    cell.className = 'colorbar-cell'
    if (i == -1) {
      cell.innerText = minVal
    } else if (i == nCells) {
      cell.innerText = maxVal
    } else {
      cell.style.backgroundColor = colorMapper(minVal + i * (maxVal - minVal) / nCells)
    }
    colorbar.append(cell)
  }

  let formatPoint = function(point) {
    let formattedPoint = {}
    formattedPoint.x = (xScientific ? point.x.toExponential() : point.x)
    formattedPoint.y = (yScientific ? point.y.toExponential() : point.y)
    formattedPoint.z = (zScientific ? point.z.toExponential() : point.z)
    return formattedPoint
  }

  // Give the points a 3D feel by adding a radial gradient
  Highcharts.setOptions({
    colors: $.map(Highcharts.getOptions().colors, function (color) {
      return {
        radialGradient: {
          cx: 0.4,
          cy: 0.3,
          r: 0.5
        },
        stops: [
          [0, color],
          [1, Highcharts.Color(color).brighten(-0.2).get('rgb')]
        ]
      }
    })
  })

  var chart = new Highcharts.Chart({
    chart: {
      renderTo: 'chart',
      margin: chartMargin,
      type: 'scatter3d',
      animation: false,
      options3d: {
        enabled: true,
        alpha: 10,
        beta: 30,
        depth: 250,
        viewDistance: 5,
        fitToPlot: false,
        frame: {
          bottom: { size: 1, color: 'rgba(0,0,0,0.02)' },
          back: { size: 1, color: 'rgba(0,0,0,0.04)' },
          side: { size: 1, color: 'rgba(0,0,0,0.06)' }
        }
      }
    },
    title: {
      text: title
    },
    subtitle: {
      text: subtitle
    },
    plotOptions: {
      series: {
        point: {
          events: {
            mouseOver: function() {
              let img1 = document.getElementById('img1')
              let img2 = document.getElementById('img2')
              let formattedPoint = formatPoint(this)

              img1.src = `./imgs/nu_${formattedPoint.x}_dt_${formattedPoint.y}_taur_${formattedPoint.z}.png`
              img2.src = `./imgs/vec_nu_${formattedPoint.x}_dt_${formattedPoint.y}_taur_${formattedPoint.z}.png`
            }
          }
        }
      }
    },
    yAxis: {
      title: {
        text: yAxisLabel,
        style: {
          fontSize: `${axisLabelSize}pt`
        }
      }
    },
    xAxis: {
      gridLineWidth: 1,
      title: {
        text: xAxisLabel,
        style: {
          fontSize: `${axisLabelSize}pt`
        }
      }
    },
    zAxis: {
      showFirstLabel: false,
      title: {
        text: zAxisLabel,
        style: {
          fontSize: `${axisLabelSize}pt`
        }
      }
    },
    legend: {
      enabled: false
    },
    series: [{
      name: 'Parameters',
      colorByPoint: false,
      data: xyz
    }],
    tooltip: {
      useHTML: true,
      formatter: function() {
        let formattedPoint = formatPoint(this.point)
        return `${xAxisLabel} = ${formattedPoint.x} <br>
        ${yAxisLabel} = ${formattedPoint.y} <br>
        ${zAxisLabel} = ${formattedPoint.z} <br>
        <b>MSD = ${msds[this.point.index]}</b>`
      }
    }
  })

  // Add mouse and touch events for rotation
  ;(function (H) {
    function dragStart(eStart) {
      eStart = chart.pointer.normalize(eStart)

      var posX = eStart.chartX,
        posY = eStart.chartY,
        alpha = chart.options.chart.options3d.alpha,
        beta = chart.options.chart.options3d.beta,
        sensitivity = 5 // lower is more sensitive

      function drag(e) {
        // Get e.chartX and e.chartY
        e = chart.pointer.normalize(e)

        chart.update({
          chart: {
            options3d: {
              alpha: alpha + (e.chartY - posY) / sensitivity,
              beta: beta + (posX - e.chartX) / sensitivity
            }
          }
        }, undefined, undefined, false)
      }

      chart.unbindDragMouse = H.addEvent(document, 'mousemove', drag)
      chart.unbindDragTouch = H.addEvent(document, 'touchmove', drag)

      H.addEvent(document, 'mouseup', chart.unbindDragMouse)
      H.addEvent(document, 'touchend', chart.unbindDragTouch)
    }

    H.addEvent(chart.container, 'mousedown', dragStart)
    H.addEvent(chart.container, 'touchstart', dragStart)
  }(Highcharts))
</script>