<!DOCTYPE html>
<html>
<head>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-3d.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script
    src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
    crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="results/data.js"></script>
</head>

<body>
<div id="container" style="display: flex">
  <div id="chart-container">
    <div id="chart"></div>
    <div id="colorbar"></div>
  </div>
  <div id="tooltip">
    <img id="img1">
    <img id="img2">
    </div>
  </div>
</div>

<style>
  #chart-container {
    height: 100%;
    flex-grow: 1;
    margin: 0 auto;
  }
  #tooltip {
    height: 100%;
    width: 50%;
  }
  #colorbar {
    display: flex;
    flex-direction: row;
    margin: 25px 25px 0px 25px;
  }
  .colorbar-cell {
    flex: 1 1 0px;
  }
  img {
    width: 100%;
  }
  /* see https://css-tricks.com/snippets/css/css-triangle/ */
  #colorbar-marker {
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid black;
  }
</style>

<script>
  // >>>>>
  // everything you need to edit should be in this section

  let xAxisLabel = 'tau_r'
  let yAxisLabel = 'nu'
  let zAxisLabel = 'lambda_r'
  let axisLabelSize = 15

  let title = 'Initial Simulation Parameter Scan'
  let subtitle = 'Click and drag to rotate; hover to show images.'

  let chartMargin = 75

  // see http://bl.ocks.org/curran/3094b37e63b918bab0a06787e161607b for examples
  // not all of those are supported, though
  let colorMap = 'Cool'
  let colorField = 'msd'

  // use scientific notation in the tooltip for (absolute) values smaller than this (except 0)
  let scientificNotationThresh = 1e-3
  // <<<<<

  // coloring things
  let minVal = data.reduce(function (prev, next) {return prev[colorField] < next[colorField] ? prev : next})[colorField]
  let maxVal = data.reduce(function (prev, next) {return prev[colorField] > next[colorField] ? prev : next})[colorField]
  let colorMapper = d3.scaleSequential(d3[`interpolate${colorMap}`]).domain([minVal, maxVal])

  // add the color bar
  let nCells = 150
  let colorbar = $('#colorbar')
  for (let i = -1; i <= nCells; i++) {
    let cell = document.createElement('div')
    cell.className = 'colorbar-cell'
    if (i == -1) {
      cell.innerText = minVal
    } else if (i == nCells) {
      cell.innerText = maxVal
    } else {
      cell.style.backgroundColor = colorMapper(minVal + i * (maxVal - minVal) / nCells)
    }
    colorbar.append(cell)
  }

  // marker for current position in the color bar
  let addMarker = function(colorbarCellNum) {
    colorbarCellNum = Math.min(colorbarCellNum + 1, nCells - 1)
    let rect = $('#colorbar')[0].children[colorbarCellNum].getBoundingClientRect()
    $('body').append(
      $('<div id="colorbar-marker"></div>').css({
        position: 'absolute',
        top: rect.y - 10,
        left: rect.x - 8,
      })
    )
  }

  let removeMarker = function(colorbarCellNum) {
    $('#colorbar-marker').remove()
  }

  // data is loaded from data.js
  for (let datum of data) {
    datum.x = datum[xAxisLabel]
    datum.y = datum[yAxisLabel]
    datum.z = datum[zAxisLabel]
    datum.color = colorMapper(datum[colorField])
  }

  /**
   * List the x, y, and z fields first, the `colorField` last and bolded, and all others
   * in arbitrary order in between.
   **/
  let getTooltip = function(point) {
    let datum = data[point.index]
    let tooltip = `
      ${xAxisLabel} = ${scientific(point.x)} <br>
      ${yAxisLabel} = ${scientific(point.y)} <br>
      ${zAxisLabel} = ${scientific(point.z)} <br>`

    // these won't be added to the tooltip in the for loop below
    let specialFields = [
      xAxisLabel, yAxisLabel, zAxisLabel, colorField,
      'x', 'y', 'z', 'color',
      'vecFilepath', 'finaltimeFilepath'
    ]

    for (let field in datum) {
      if (!specialFields.includes(field)) {
        tooltip += `${field} = ${scientific(datum[field])} <br>`
      }
    }

    tooltip += `<b>${colorField} = ${scientific(datum[colorField])}</b>`
    return tooltip
  }

  let scientific = function(n) {
    if (n == 0) {
      return n
    } else {
      return Math.abs(n) <= scientificNotationThresh ? n.toExponential() : n
    }
  }

  // Give the points a 3D feel by adding a radial gradient
  Highcharts.setOptions({
    colors: $.map(Highcharts.getOptions().colors, function (color) {
      return {
        radialGradient: {
          cx: 0.4,
          cy: 0.3,
          r: 0.5
        },
        stops: [
          [0, color],
          [1, Highcharts.Color(color).brighten(-0.2).get('rgb')]
        ]
      }
    })
  })

  let chart = new Highcharts.Chart({
    chart: {
      renderTo: 'chart',
      margin: chartMargin,
      type: 'scatter3d',
      animation: false,
      options3d: {
        enabled: true,
        alpha: 10,
        beta: 30,
        depth: 250,
        viewDistance: 5,
        fitToPlot: false,
        frame: {
          bottom: { size: 1, color: 'rgba(0,0,0,0.02)' },
          back: { size: 1, color: 'rgba(0,0,0,0.04)' },
          side: { size: 1, color: 'rgba(0,0,0,0.06)' }
        }
      }
    },
    title: {
      text: title
    },
    subtitle: {
      text: subtitle
    },
    plotOptions: {
      series: {
        point: {
          events: {
            mouseOver: function() {
              let img1 = document.getElementById('img1')
              let img2 = document.getElementById('img2')

              let index = this.index.toString().padStart(6, '0')

              img1.src = data[this.index].finaltimeFilepath
              img2.src = data[this.index].vecFilepath

              // update colorbar position
              removeMarker()
              addMarker(Math.floor((data[this.index][colorField] - minVal) * nCells / (maxVal - minVal)))
            }
          }
        }
      }
    },
    yAxis: {
      title: {
        text: yAxisLabel,
        style: {
          fontSize: `${axisLabelSize}pt`
        }
      }
    },
    xAxis: {
      gridLineWidth: 1,
      title: {
        text: xAxisLabel,
        style: {
          fontSize: `${axisLabelSize}pt`
        }
      }
    },
    zAxis: {
      showFirstLabel: false,
      title: {
        text: zAxisLabel,
        style: {
          fontSize: `${axisLabelSize}pt`
        }
      }
    },
    legend: {
      enabled: false
    },
    series: [{
      name: 'Parameters',
      colorByPoint: false,
      data: data
    }],
    tooltip: {
      useHTML: true,
      formatter: function() {
        return getTooltip(this.point)
      }
    }
  })

  // Add mouse and touch events for rotation
  ;(function (H) {
    function dragStart(eStart) {
      eStart = chart.pointer.normalize(eStart)

      var posX = eStart.chartX,
        posY = eStart.chartY,
        alpha = chart.options.chart.options3d.alpha,
        beta = chart.options.chart.options3d.beta,
        sensitivity = 5 // lower is more sensitive

      function drag(e) {
        // Get e.chartX and e.chartY
        e = chart.pointer.normalize(e)

        chart.update({
          chart: {
            options3d: {
              alpha: alpha + (e.chartY - posY) / sensitivity,
              beta: beta + (posX - e.chartX) / sensitivity
            }
          }
        }, undefined, undefined, false)
      }

      chart.unbindDragMouse = H.addEvent(document, 'mousemove', drag)
      chart.unbindDragTouch = H.addEvent(document, 'touchmove', drag)

      H.addEvent(document, 'mouseup', chart.unbindDragMouse)
      H.addEvent(document, 'touchend', chart.unbindDragTouch)
    }

    H.addEvent(chart.container, 'mousedown', dragStart)
    H.addEvent(chart.container, 'touchstart', dragStart)
  }(Highcharts))
</script>
</body>
</html>
